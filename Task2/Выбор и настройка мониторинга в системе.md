# Выбор и настройка мониторинга в системе

## 1. Мотивация

Сейчас бизнес использует Яндекс Метрику, но она отражает только поведение пользователей веб-магазина. После запуска API для партнёров значительная часть заказов проходит мимо Метрики. Это создаёт риски:

- **Отсутствие прозрачности**: бизнес не знает реальную загрузку системы и качество работы API.
- **Проблемы видны слишком поздно**: сбои фиксируются только через жалобы клиентов.
- **Невозможно планировать рост**: нет понимания, где возникают узкие места (MES, CRM, очередь сообщений).

Мониторинг позволит:
- Снизить SLA-риски (обнаруживать проблемы до того, как их заметят клиенты).
- Ускорить реакцию DevOps и разработчиков на инциденты.
- Повысить доверие клиентов и партнёров (API станет предсказуемым).
- Дать бизнесу цифры для решений: где нужны новые мощности, где узкие места.

---

## 2. Выбор подхода к мониторингу

Мы будем комбинировать подходы:

- **RED (Rate, Errors, Duration)** — для API-сервисов (Shop API, CRM API, MES API).  
  Позволяет понять: сколько запросов приходит, сколько из них завершается ошибкой, и с какой задержкой.

- **USE (Utilization, Saturation, Errors)** — для инфраструктуры (RabbitMQ, базы данных, файловое хранилище).  
  Нужен, чтобы контролировать использование ресурсов, насыщение и ошибки.

- **Четыре золотых сигнала (Latency, Traffic, Errors, Saturation)** — для общей картины работы системы (в т.ч. UI приложений: Internet Shop, CRM, MES).

---

## 3. Метрики и их описание

### 3.1 Shop API, CRM API, MES API (RED)
- **Rate (rps)** — количество запросов в секунду.
    - Зачем: понять нагрузку и прогнозировать масштабирование.
    - Ярлыки: метод (`GET /orders`, `POST /submit`), источник (`web`, `api-partner`).

- **Errors (%)** — доля ошибок 4xx/5xx.
    - Зачем: выявлять сбои и проблемные эндпоинты.
    - Ярлыки: код ответа, метод.

- **Duration (ms)** — время ответа.
    - Зачем: SLA по API.
    - Ярлыки: эндпоинт, клиент (`partner_id`).

---

### 3.2 RabbitMQ (USE)
- **Queue depth** — количество сообщений в очереди.
    - Зачем: оценка задержек обработки.
    - Ярлыки: название очереди (`orders`, `status`).

- **Message ack / unacked**.
    - Зачем: контроль доставки и обработки.

- **Consumer lag** (разница между rate поступления и rate обработки).
    - Зачем: понять, успевают ли сервисы обрабатывать сообщения.

---

### 3.3 Базы данных (Shop DB, MES DB)
- **Query latency** — время выполнения SQL-запросов.
    - Зачем: поиск «тяжёлых» запросов.
    - Ярлыки: тип запроса (`select`, `update`), таблица.

- **Connections usage** — использование пула соединений.
    - Зачем: контроль перегрузки.

- **Replication lag** (если введём реплики).
    - Зачем: следить за актуальностью данных.

---

### 3.4 MES (как узкое место)
- **Время загрузки дашборда**.
    - Зачем: ключевой UX-показатель.
    - Ярлыки: количество заказов, оператор.

- **Время расчёта стоимости заказа**.
    - Зачем: SLA для клиентов и API.
    - Ярлыки: тип модели (простая, сложная).

---

### 3.5 3D Files Storage
- **Upload latency** — время загрузки файла.
- **Download latency** — время скачивания для расчёта.
- **Ошибки (5xx)** — неудачные загрузки/выгрузки.

---

### 3.6 Бизнес-метрики (для продакта)
- **Количество заказов по статусам** (INITIATED, SUBMITTED, PRICE_CALCULATED, SHIPPED, CLOSED).
    - Зачем: видеть конверсию и узкие места.
    - Ярлыки: канал (`web`, `api`), период времени.

- **Среднее время перехода между статусами** (например, PRICE_CALCULATED → MANUFACTURING_APPROVED).
    - Зачем: контроль SLA на бизнес-уровне.

---

## 4. Инструменты и внедрение

- **Prometheus** — сбор технических метрик.
- **Grafana** — визуализация и дашборды.
- **ELK** — централизованное логирование.
- **Alertmanager** — правила алертинга (например, >5% ошибок API за 5 мин).

---

## 5. Ожидаемый результат для бизнеса

- **Сокращение времени реакции на инциденты**: проблемы в API или MES будут видны за минуты, а не после жалоб.
- **Прозрачная работа API для партнёров**: можно гарантировать SLA и удерживать контракты.
- **Рост удовлетворённости операторов**: дашборд MES будет контролироваться по времени отклика.
- **Данные для решений**: какие модули надо усиливать, где узкие места в процессах.

---

