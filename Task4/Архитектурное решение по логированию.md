# Архитектурное решение по логированию

## 1. Мотивация

Сегодня ошибки и инциденты выявляются в основном через жалобы клиентов. Это приводит к:
- долгому времени расследования (разработчики ищут «вслепую»),
- высокой нагрузке на поддержку,
- отсутствию прозрачности для бизнеса, где именно возникают сбои.

Внедрение централизованного логирования даст:
- прозрачность всех операций с заказами,
- возможность быстро находить и устранять ошибки,
- защиту от инцидентов 

**Метрики, на которые повлияет внедрение:**
1. MTTR ↓ — время на разбор инцидента.
2. SLA по заказам ↑ — меньше случаев «пропавших» заказов.
3. Количество обращений в поддержку ↓.
4. Время вывода новых фич ↓ (разработчики быстрее понимают, что сломалось).

---

## 2. Системы для сбора логов

Логирование необходимо включить во все системы, участвующие в жизненном цикле заказа:
- **Shop API** — создание заказа, загрузка файлов, сохранение в DB.
- **CRM API** — подтверждение заказа, взаимодействие с продавцами.
- **MES API** — расчёт стоимости, назначение операторов, переход статусов.
- **RabbitMQ** — ошибки доставки сообщений, dead-letter события.
- **Базы данных (Shop DB, MES DB)** — ошибки запросов, долгие запросы.
- **3D Storage** — загрузка/скачивание файлов.

Приоритет первой очереди (логирование + трейсинг):
1. **MES API** (самое узкое место, долгие операции).
2. **Shop API** (стартовый вход заказов).
3. **RabbitMQ** (частая причина потерь сообщений).

---

## 3. Список логов уровня INFO

Примеры событий, которые логируются на уровне INFO:
- Создание заказа (order_id, customer_id, timestamp, статус = INITIATED).
- Изменение статуса заказа (order_id, old_status, new_status, service, timestamp).
- Загрузка файла (order_id, file_id, размер, результат).
- Расчёт стоимости (order_id, duration, результат).
- Отправка/получение сообщения RabbitMQ (queue_name, order_id, status).
- Подтверждение заказа CRM (order_id, seller_id, status).

---

## 4. Другие уровни логирования

- **DEBUG** — подробная отладка, только в dev/release. Например: SQL-запросы, промежуточные шаги расчёта.
- **WARN** — нестандартные ситуации (например, повторная загрузка одного и того же файла).
- **ERROR** — ошибки сервисов (падение транзакции, таймаут запроса, отказ RabbitMQ).
- **FATAL** — критические сбои (недоступна база, очередь не принимает сообщения).

---

## 5. Предлагаемое решение

### Технологии
- Использовать **OpenTelemetry** для унифицированного формата логов.
- Хранение и поиск логов — **ELK (Elasticsearch + Logstash + Kibana)**.
- Централизованный сбор через **Filebeat**.
- Визуализация — Kibana или Grafana.

### Архитектурные компоненты
- Новый компонент **Log Collector** (сбор логов с сервисов).
- Новый компонент **Log Storage (ELK)**.
- Новый компонент **Log UI (Kibana/Grafana)**.

Ссылка на диаграмму: Task4/diagram/loging.puml

## 6. Политика безопасности

- Персональные данные (PII) маскируются до попадания в логи.
- Доступ к логам только через корпоративный SSO.
- Ролевая модель: Support видит события без PII, DevOps/разработчики имеют расширенный доступ.
- Шифрование логов при передаче (TLS).

---

## 7. Политика хранения

- Логи разделяются по индексам: Shop, CRM, MES, RabbitMQ.
- Время хранения:
    - **30 дней** — быстрый доступ для расследований,
    - **90 дней** — архив на дешёвом storage.

---

## 8. Система анализа логов

- **Алертинг**:
    - более 5% ошибок API за 5 минут,
    - заказ в статусе > N минут,
    - очередь RabbitMQ переполнена.
- **Поиск аномалий**:
    - резкий рост количества заказов (подозрение на DDoS),
    - нет заказов в течение длительного времени.
- **Дашборды**: для бизнес-команды (количество заказов по статусам) и для техподдержки (ошибки, задержки).

---

## 9. Дополнительное задание — критерии выбора технологии

| Критерий        | ELK                         | OpenSearch                  | Splunk                     | Loki/Grafana                |
|-----------------|-----------------------------|-----------------------------|----------------------------|-----------------------------|
| Лицензия        | Elastic License             | Apache 2.0                  | Проприетарная              | OSS (Apache 2.0)            |
| Стоимость       | Бесплатно + поддержка $$$   | Бесплатно                   | Очень дорого               | Бесплатно                   |
| Масштабируемость| Высокая                     | Высокая                     | Очень высокая              | Средняя (но лёгкая)         |
| Интеграция      | Широкая (Logstash, Beats)   | Широкая (Fluentd, Beats)    | Отличная (но закрытая)     | Отличная в Grafana Stack    |
| Удобство UI     | Kibana (мощно, но сложно)   | OpenSearch Dashboards       | Лучшее из коробки          | Ограниченный поиск, но лёгкий|
| Поддержка       | Elastic.co                  | AWS, сообщество             | Vendor                     | Сообщество + Grafana Labs   |

**Выбор:** для компании разумно начать с **OpenSearch** (лицензия Apache, совместимость с ELK, лёгкий вход).


